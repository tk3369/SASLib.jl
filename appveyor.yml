image: ubuntu-latest

# Script mode configuration
build: off

# Build script
build_script:
  - ps: Write-Host "Starting build script..."

# Environment setup
environment:
  matrix:
    - JULIA_URL: "https://julialang-s3.julialang.org/bin/winnt/x64/1.6/julia-1.6.7-win64.exe"
    - JULIA_URL: "https://julialang-s3.julialang.org/bin/winnt/x64/1/julia-latest-win64.exe"
    - JULIA_URL: "https://julialangnightlies-s3.julialang.org/bin/winnt/x64/julia-latest-win64.exe"
      JULIA_NIGHTLY: "true"

platform:
  - x64

matrix:
  allow_failures:
    - JULIA_URL: "https://julialangnightlies-s3.julialang.org/bin/winnt/x64/julia-latest-win64.exe"

branches:
  only:
    - master
    - /release-.*/

notifications:
  - provider: Email
    on_build_success: false
    on_build_failure: false
    on_build_status_changed: false

install:
  - ps: |
      $version = $env:JULIA_VERSION
      if ($version -eq $null) { $version = "1.6.7" }
      $is_nightly = $env:JULIA_NIGHTLY -eq "true"
      $url = $env:JULIA_URL
      if ($url -eq $null) {
          $url = "https://julialang-s3.julialang.org/bin/winnt/x64/$($version.Substring(0, $version.LastIndexOf('.')))/julia-$version-win64.exe"
      }
      $installer = (Join-Path $pwd "julia-installer.exe")
      (new-object net.webclient).DownloadFile($url, $installer)
      Start-Process -FilePath $installer -ArgumentList "/S /D=$pwd\julia" -Wait

test_script:
  - SET PATH=%CD%\julia\bin;%PATH%
  - echo "%JL_TEST_SCRIPT%"
  - julia -e "%JL_TEST_SCRIPT%"
